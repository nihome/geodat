name: Build Minimal Geosite
on:
  #schedule:
  #  - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4
        with:
          path: nihome

      - name: Checkout upstream rules
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: upstream

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: upstream/go.mod
          cache-dependency-path: upstream/go.sum

      - name: Set variables
        run: |
          echo "RELEASE_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
          echo "TAG_NAME=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
        shell: bash

      - name: Get and Merge Rules
        run: |
          # 下载 Loyalsoldier 的成品并存入 data 目录
          curl -sL https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/gfw.txt -o upstream/data/gfw
          curl -sL https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/apple-cn.txt -o upstream/data/apple-cn
          curl -sL https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/google-cn.txt -o upstream/data/google-cn
          
          if [ -d "nihome/data" ]; then
            cp -rf nihome/data/* upstream/data/
          fi

      - name: Build geosite.dat
        run: |
          mkdir -p publish
          cd upstream || exit 1
          
          go run ./ --outputdir=../publish --outputname=geosite.dat --datapath=./data --exportlists=gfw,direct,block,ads,proxy
          
          cd ../
          sha256sum publish/geosite.dat > publish/geosite.dat.sha256sum
          # 拷贝文本副本备用
          cp upstream/data/gfw publish/gfw.txt
          cp upstream/data/apple-cn publish/apple-cn.txt
          cp upstream/data/google-cn publish/google-cn.txt

      - name: Get geoip.dat
        run: |
          curl -sL https://github.com/v2fly/geoip/releases/latest/download/geoip-only-cn-private.dat -o publish/geoip.dat
          curl -sL https://github.com/v2fly/geoip/releases/latest/download/geoip-only-cn-private.dat.sha256sum -o publish/geoip.dat.sha256sum

      - name: Release and upload assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: ${{ env.RELEASE_NAME }}
          tag: ${{ env.TAG_NAME }}
          file_glob: true
          file: ./publish/*
